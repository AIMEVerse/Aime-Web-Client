<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>AIME</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <meta name="keywords" content="AIME,AI,Metaverse">
    <meta name="author" content="AIME Web3 Technologies">
    <meta name="generator" content="Spell" />
    <meta content="AIME" name="title">
    <meta content="Artificial Intelligence Metaverse Experience" name="description">
    <meta content="aimeverse.com" property="og:site_name">
    <meta content="AIME | Personal Metaverse" property="og:title">
    <meta content="AI Metaverse Experience" property="og:description">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous">
        </script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Quicksand">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>



</head>

<body class="bg-dark">

    <script type="module" defer>
        import { Spell, Spell3d, Spell3dModule, SpellUI, SpellUIModule, SpellData ,SpellEvents } from '/lib/spell/index.js'
        import * as THREE from 'three'
        import { Quaternion } from "three";
        import { SpaceHudObjects, HudWindow } from '/src/space-hud.js'
        import "/lib/spell/style/spell.css"
        import "/public/style/space-hud.css"

        import * as tf from "@tensorflow/tfjs"
        import * as handpose from "@tensorflow-models/handpose"

       



        // const model_cdn_key = "30f925a1-c00e-4fcf-aaef-2f70af2d3810"
        // const model_cdn_key = "4ef19c78-dde0-4f53-a433-2d35071cbd20"

        let delta = new THREE.Clock();

        



        //
        let spell_ui_module = new SpellUIModule()
        Spell.load_module(new Spell3dModule())
        spell_ui_module.engine.import_objects(SpaceHudObjects)
        Spell.load_module(spell_ui_module)

        Spell.start()

        const spellmodule = Spell.get_module('spell3d')
        let video_playing = false
       
        function hasGetUserMedia() {
            return !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
        }
       
        async function load_hands_model() {
            const net = await handpose.load()
            setInterval(() => { detect(net) },100)
        }

        const enable_cam = (input_video)=> {
            if (hasGetUserMedia()) {
                // getUsermedia parameters.
                const constraints = {
                    video: true,
                    width: 320,
                    height: 280
                };

                // Activate the webcam stream.
                navigator.mediaDevices.getUserMedia(constraints).then((stream) => {
                    input_video.srcObject = stream;
                    input_video.addEventListener('loadeddata',async  () => {
                        video_playing = true;
                        //console.log("video running");
                        await load_hands_model()
                        //ENABLE_CAM_BUTTON.classList.add('removed');
                        //detect()
                    });
                });
            } else {
                console.warn('getUserMedia() is not supported by your browser');
            }
        }

        async function detect(net) {
        
            if(video_playing) {
                const vid = document.getElementById("vid-hands")
                //const video_settings = vid.srcObject?.getVideoTracks()[0]?.getSettings()
                //console.log(video_settings)
                const hands = await net.estimateHands( vid)
                if(hands.length>0) {
                    SpellData.objects["landmarks"]  = hands[0]["landmarks"][0]
                    //console.log(SpellData.objects["landmarks"]);
                }
            }
        }
        
        setTimeout(() => {
                const button = document.getElementById("cam-button")
                button.addEventListener('click',(event) => {
                        const vid = document.getElementById("vid-hands")
                        enable_cam(vid)
                    }
                )
            },1000
        
        )

        const lights = {
            "main": {
                _type: "light",
                _light: "ambient",
                color: 0x444466
            },
            "p1": {
                _type: "light",
                _light: "directional",
                _helper: true,
                color: "hsl(180, 0%, 60%)",
                intensity: 1,
                _position: { x: 5, y: 10, z: -30 },

            },
            "p2": {
                _type: "light",
                _light: "directional",
                color: "hsl(180, 0%, 60%)",
                intensity: 1,
                _position: { x: 5, y: 5, z: 30 },

            },
            "p3": {
                _type: "light",
                _light: "directional",
                color: "hsl(180, 0%, 60%)",
                intensity: 1,
                _position: { x: -20, y: 5, z: 0 }

            },
            "p4": {
                _type: "light",
                _light: "directional",
                color: "hsl(180, 0%, 60%)",
                intensity: 1,
                _position: { x: 20, y: 5, z: 0 }
            },
            "top-light": {
                _type: "light",
                _light: "directional",
                color: "hsl(180, 0%, 80%)",
                intensity: 1,
                _position: { x: -0.3, y: 16, z: 0 }
            }
        }

        let world = {
            "html-wrapper": "spell3d-player",
            scene: {
                "lights": lights,

                cameras: {
                    "main-cam": {
                        _type: "perspective-camera",
                        fov: 20,
                        ratio: window.innerWidth / window.innerHeight,
                        _clipping: {
                            far: 5000,
                            close: 0.01
                        },
                        _position: { x: 0, y: 0, z: 0 },
                        _rotation: { x: 0, y: 0, z: 0 },
                        _disable_frame_3d_state: true
                    }
                },
                controls: {
                    "cam-control": {
                        _type: "orbit",
                        _active: true,
                        _params: {
                            enableDamping: true,
                            minPolarAngle: Math.PI / 2.5,
                            maxPolarAngle: Math.PI / 1.5,
                            minDistance: 2,
                            maxDistance: 10,
                            rotateSpeed: 0.3,
                        }
                    }
                }

            },
            html_binding: {
                wrapper_elemnt: "spell3d-player"
            },
            "spell3d-objects": {
                "pointer": {
                    _type: "sphere",
                    _id: "pointer",
                    _geometry: {
                        _type: "sphere-geometry",
                        widthSegments: 8,
                        heightSegments: 8,
                        radius: 0.01
                    },
                    _material: {
                        _type: "basic-material",
                        color: 0xff99ff,
                        side: 2,
                        // roughness: 0.5,
                    },
                    _position: { x: 0, y: 0.3, z: 0 },
                    _rotation: { x: 0, y: 0, z: 0 },
                    castShadow: true,
                    onframe: `follow-joystick`
                },
                "pointer2": {
                    _type: "sphere",
                    _id: "pointer3",
                    _geometry: {
                        _type: "sphere-geometry",
                        widthSegments: 8,
                        heightSegments: 8,
                        radius: 0.01
                    },
                    _material: {
                        _type: "basic-material",
                        color: 0x0099ff,
                        side: 2,
                        // roughness: 0.5,
                    },
                    _position: { x: 1, y:1, z: 0 },
                    _rotation: { x: 0, y: 0, z: 0 },
                    castShadow: true,
                    onframe: `follow-landmark 0`
                },
                "cube": {
                    name: "Box",
                    _type: "box",
                    _id: "boxy",

                    _geometry: {
                        _type: "box-geometry",
                        width: 2,
                        height: 0.01,
                        depth: 2,
                        widthSegments: 2,
                        heightSegments: 2,
                        depthSegments: 2
                    },
                    _material: {
                        _type: "standard-material",
                        color: 0x00ff00,
                        side: 2
                    },
                    _position: { x: 0, y: 0.1, z: 0 },
                    _rotation: { x: 0, y: 0, z: 0 },
                    _transform_controls: false,
                    _disable_frame_3d_state: true
                }

            }
        }
        //console.log(world)
        // const sfile = "https://cdn.pai-net.org/pai-cdn/get-file?cdn-key=" + model_cdn_key
        // const sfile = "/public/models/aime.gltf"
        // console.log(sfile);
        await Spell3d.load_world(world)
        // const scmd = {
        //     module: "spell3d",
        //     op: "load-gltf",
        //     params: {
        //         file: sfile
        //     }
        // }
        // Spell.execute(scmd)


        // setTimeout(() => {
        //     Spell.get_module('spell3d').run("Huge_Sign spin y:0.01");
        //     Spell.get_module('spell3d').run("Huge_Sign001 spin y:0.01");
        //     Spell.get_module('spell3d').run("Huge_Sign002 spin y:0.02");
        //     Spell.get_module('spell3d').run("AIMEModel003 hover axis:y dir:up radius:0.1 step:0.001");
        // }, 10000);

        //run 3d-engine  -> run animation loop

        const spell_app = {
            spell: {
                version: 1
            },
            views: {
                "intro": {
                    _type: "view"
                },
                "main-view": {
                    _type: "view",
                    _id: "main-view",
                    style: "width:100%;margin: 0;padding:0;display:none",
                    "class": "container-fluid xyz-in ",
                    animation: "fade",
                    spells: [
                        {
                            _id: "pos-label",
                            _type: "label",
                            _data_source: "joystick-position",
                            style: "color:white;margin-left:50px",
                        },
                        {
                            _id:"cam-button",
                            _type:"button",
                            text:"cam",
                            style:"width:100px;height:100px;background-color:green"
                        },
                        {
                            _id: "spell-terminal",
                            _type: "view",
                            class: "terminal",
                            spells: [
                                {
                                    _id: "spell-command",
                                    _type: "text",
                                    placeholder: "write spell here",
                                    value: "box rotate",
                                    class: "terminal-line"
                                }
                            ]
                        },



                    ]
                }
            },
            defaults: {
                view: "main-view"
            },
            player: {
                html_element: "spell-player"
            }

        }


        SpellUI.load_app(spell_app)

        SpellUI.vm.show_view("main-view")

        const joystick = {
            _id: "joystick-1",
            _type: "joystick",
            _parent_element: "spell-controls",
            _joy_options: {
                size: 120,
                multitouch: true,
                maxNumberOfNipples: 1,
                mode: 'static',
                restJoystick: true,
                shape: 'circle',
                // position: { top: 20, left: 20 },
                position: { bottom: '90px', left: '90px' },
                dynamicPage: true,
                color: "grey"
            }
        }

        Spell.get_module("spell-ui").engine.load_control(joystick)

        const dashboard = {
            _type: "spell-dashboard",
            _parent_element: "spell-controls",
        }

        Spell.get_module("spell-ui").engine.load_control(dashboard)






        let fav_data = {
            _id: "hud-4",
            _type: "hud-favorites",
            _parent_element: "spell-controls",
            // style: "position: absolute; right:0; top:0;",
            draggable: true,
            _items: [
                { title: "Start", data: { x: -10, y: 1.75, z: 21.3 } },
                { title: "AIME's room", data: { x: -18.02, y: 1.75, z: 0.68 } },
                { title: "Special Room", data: { x: 1.81, y: 1.75, z: -1.442 } }
            ]
            // _title: "PAI Favorites"
        };

        Spell.get_module("spell-ui").engine.load_control(fav_data)
        //Spell.info()
        //document.getElementById("info-layer").style.display="none"
        //  let v = new SpellView({"text":"HI"})
        //  document.querySelector("#spell-player").innerHTML = v.get_html()


        
        document.addEventListener('keydown', async (event) => {


            // if (event.key.toLocaleLowerCase() == "~" && event.shiftKey) {
            //     event.preventDefault()
            //     //event.stopPropagation()
            //     toggle_spell()
            //     return 

            // }
            // if (event.key == "Enter") {
            //     event.preventDefault()
            //     send_command()
            //     return;
            // }

             if (event.key == "j") {
                //Spell.get_module('spell3d').engine.set_camera_path()
                Spell.get_module('spell3d').engine.om.spell_objects["pointer"]["onframe"] = "follow-path"
                return;
            }
            else if (event.key == "u") {
                Spell.get_module('spell3d').engine.set_camera_path()
                //Spell.get_module('spell3d').engine.om.spell_objects["pointer"]["onframe"] = "follow-path"
                return;
            }
            else if (event.key == "p") {
                Spell.get_module('spell3d').engine.set_camera_path_point()
                return;
            }
            else if (event.key == "o") {
                const format = "png";
                Spell.get_module('spell3d').engine.add_environment_map('/images/space2048/', [
                    `px.${format}`,
                    `nx.${format}`,
                    `py.${format}`,
                    `ny.${format}`,
                    `pz.${format}`,
                    `nz.${format}`,
                ])
                return;
            }




        }, false);




        function toggle_spell() {
            const player = $("#spell-player")

            player.toggle()
            if (player.is(":visible")) {
                $("#spell-command").focus();
            }

            //Spell.om.get_object("info-layer").show()
        }




        function send_command() {
            const player = $("#spell-player")

            if (player.is(":visible")) {
                const cmnd_line = $("#spell-command")
                const scmd = cmnd_line.val()
                if (scmd && scmd.length > 1) {
                    let res = Spell.get_module('spell3d').run(scmd)   //run from module directly
                }
            }

        }



        function send_command2(cmd) {

            let res = Spell.get_module('spell3d').run(cmd)   //run from module directly

        }


        document.addEventListener('fav-add-item', (event) => {
            //Spell.get_module('spell3d').engine.raycast(event)
            // send_command2(`pointer position x:${event.detail.x} z:${event.detail.z}`)
            const vec = SpellData.objects["joystick-vector"];
            Spell.get_module("spell-ui").engine.om.spell_objects["hud-4"].add_new_items({ title: "New item", data: { x: vec.x, y: vec.y, z: vec.z } });


        }, false);

        document.addEventListener('fav-click', (event) => {
            //Spell.get_module('spell3d').engine.raycast(event)
            send_command2(`pointer position x:${event.detail.x} z:${event.detail.z}`)

        }, false);

        document.addEventListener('mousedown', (event) => {
            //send_command2(`spell3d world_lock_controls`)
            
            Spell.get_module('spell3d').engine.raycast(event)
        }, false);




        document.addEventListener('spell-add', (event) => {
            const obj = JSON.parse(event.detail)

            if (obj.defaults) {
                console.log(obj)
                const sc = {
                    module: "spell3d",
                    op: "add",
                    params: obj.defaults
                }
                Spell.execute(sc)
            }
        }, false);


    </script>

    <div id="spell3d-player" class="spell3d-player"></div>
    <div id="spell-controls"></div>
    <div id="spell-player"></div>
    <video id="vid-hands" style="position:fixed;top:50px;left:50px;background-color:red;width:320px;height:280px;transform: scale(-1, 1);filter: FlipH;" autoplay muted></video>
        
        
    
</body>

</html>